/*
**author:jasonYang**
**web:jasonload.zglingjie.com**
**email:914412726@qq.com**
*/
define("common_plugin/jasonCacheDB",[],function(a,b,c){jl.isString=function(a){return"string"==typeof a};var d=function(a){var b=this;return jl.isObject(a)&&jl.isObject(a.table_model)?"undefined"==typeof a.table_name?alert("参数中表名table_name必填。"):(isNaN(parseInt(a.expired))||(a.expired=!0),b.opt=a,b.param_model={select:"",condition:"",order_by:[]},void(b.param=jl.extend({},{},b.param_model))):alert("请正确配置参数，格式为{table_model:{},table_name:table_name}")};d.prototype={_setKey:function(a){var b=this;jl.setData("jasonCacheDB_"+b.opt.table_name+"_key",a,b.opt.expired,"global")},_pushKey:function(){var a,b=this,c=b._getKey();return c.length<=0?(a=1,c.push(a)):(a=c[c.length-1]+1,c.push(a)),b._setKey(c),a},_getKey:function(){var a=this,b=jl.getData("jasonCacheDB_"+a.opt.table_name+"_key","global");return jl.isArray(b)||(b=[]),b},_set:function(a,b){var c=this;jl.setData("jasonCacheDB_"+c.opt.table_name+"_"+b,a,c.opt.expired,"global")},_new:function(a){var b=this;b._set(a,b._pushKey())},_get:function(a,b){var c=this,d=jl.getData("jasonCacheDB_"+c.opt.table_name+"_"+a,"global");return jl.isObject(d)&&(b?d.jasonCacheDB_key=a:d=c._formatObj(d)),d},_getWhere:function(a,b){for(var c,d=this,e=d._getKey(),f=[],g=1,h=0;h<e.length;h++)if(c=d._get(e[h],b),g=1,jl.isObject(c)){if(jl.isObject(a))for(var i in a){if("undefined"==typeof c[i])return alert("表"+d.opt.table_name+"中不存在查询条件中的字段“"+i+"”"),[];c[i]!=a[i]&&(g=0)}g&&f.push(c)}return f},_formatObj:function(a){var b=this,c=jl.extend({},{},b.opt.table_model);for(var d in c)"undefined"!=typeof a[d]&&(c[d]=a[d]);return c},_selectObj:function(a){var b=this,c=b.param.select;if(""==c)return a;for(var d,e={},f=c.split(","),g=0;g<f.length;g++)d=f[g],"undefined"!=typeof a[d]&&(e[d]=a[d]);return e},select:function(a){var b=this;return jl.isString(a)?(b.param.select=a,b):(alert("select()函数的参数必须为字符串，请检查！"),b)},where:function(a){var b=this;return jl.isObject(a)?(b.param.condition=a,b):(alert("where(condition)函数的参数必须为对象，请检查！"),b)},order_by:function(a){var b=this;return!jl.isArray(a)||a.length<1||!jl.isString(a[0])||""==a[0]?(alert("order_by(arr)函数的参数必须为数组，请检查！"),b):(b.param.order_by=a,b)},result:function(){for(var a=this,b=a._getWhere(a.param.condition),c=[],d=a.param.order_by,e=0;e<b.length;e++)c.push(a._selectObj(b[e]));return d.length>=1&&c.sort(function(a,b){return d.length>=2&&"desc"==d[1]?parseFloat(b[d[0]])-parseFloat(a[d[0]]):parseFloat(a[d[0]])-parseFloat(b[d[0]])}),a.param=jl.extend({},{},a.param_model),c},row:function(a){var b=this;a=isNaN(parseInt(a))?0:a;var c,d=b._getWhere(b.param.condition);return c=d.length<=a?"":b._selectObj(d[a]),b.param=jl.extend({},{},b.param_model),c},insert:function(a){var b=this;if(jl.isArray(a))for(var c=0;c<a.length;c++)b._new(b._formatObj(a[c]));else{if(!jl.isObject(a))return alert("add(obj)的obj必须为对象或对象数组");b._new(b._formatObj(a))}return b},update:function(a,b){var c=this;b=jl.isObject(b)?b:c.param.condition;for(var d=c._getWhere(b,!0),e={},f=0;f<d.length;f++){e=d[f];for(var g in a)"undefined"!=typeof e[g]&&(e[g]=a[g]);isNaN(parseInt(e.jasonCacheDB_key))||c._set(e,e.jasonCacheDB_key)}return c},"delete":function(a){var b=this;a=jl.isObject(a)?a:b.param.condition;for(var c=b._getWhere(a,!0),d={},e=[],f=[],g="",h=0;h<c.length;h++)d=c[h],isNaN(parseInt(d.jasonCacheDB_key))||(b._set("",d.jasonCacheDB_key),g+=d.jasonCacheDB_key+",");e=b._getKey(),f=[];for(var i=0;i<e.length;i++)g.indexOf(e[i]+",")<0&&f.push(e[i]);return b._setKey(f),b},destroy:function(){var a=this;a.delete(""),a._setKey([])}},c.exports=d});